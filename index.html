<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代码测试</title>
    <link rel="stylesheet" href="./index.css">
</head>
<body>
<div id="slideJigsaw" class="slide-jigsaw">
    <canvas class="panel" width="300" height="150"></canvas>
    <div class="control">
        <div class="indicator"></div>
        <div class="slider">→</div>
        <div class="tips">向右拖动滑块填充拼图</div>
    </div>
</div>
<script>
  const slideJigsaw = {
    init(options) {
      this.slideJigsaw = document.querySelector('#slideJigsaw')

      // dom
      this.panel = this.slideJigsaw.querySelector('.panel')
      this.slider = this.slideJigsaw.querySelector('.slider')
      this.img = document.createElement('img')

      // size
      this.w = this.panel.width
      this.h = this.panel.height
      this.x = this.w / 2
      this.y = this.h / 4
      this.l = 40
      this.r = 10

      // canvas
      this.jigsaw = this.createCanvas()
      this.panel_ctx = this.panel.getContext('2d')
      this.jigsaw_ctx = this.jigsaw.getContext('2d')

      // options
      Object.assign(this, options)

      this.img.onload = () => {
        this.panel_ctx.drawImage(this.img, 0, 0, this.w, this.h)
        this.jigsaw_ctx.drawImage(this.img, 0, 0, this.w, this.h)

        const _w = this.l + this.r * 2
        const _y = this.y - this.r * 2
        const imageData = this.jigsaw_ctx.getImageData(this.x, _y, _w, _w)

        this.jigsaw.width = _w // 不能使用 style 的 width
        this.jigsaw_ctx.putImageData(imageData, 0, _y)
      }

      // draw
      this.setImg('./index.jpg')
    },

    reset() {
      this.jigsaw.style.left = this.slider.style.left = '0px'
      this.x = Math.round(Math.random() * 170 + 70)
      this.y = Math.round(Math.random() * 15 + 70)

      this.panel_ctx.clearRect(0, 0, 310, 155)
      this.jigsaw_ctx.clearRect(0, 0, 310, 155)
    },

    createCanvas() {
      const canvas = document.createElement('canvas')

      Object.assign(canvas.style, {
        position: 'absolute',
        top: this.retPx(0),
        left: this.retPx(0)
      })

      this.slideJigsaw.append(canvas)
      return canvas
    },

    setImg(src) {
      this.img.src = src

      this.draw(this.panel_ctx, 'fill')
      this.draw(this.jigsaw_ctx, 'clip')

      // 各种事件
      this.bindEvents()
    },


    draw(ctx, operation) {
      const {x, y, l, r} = this
      const PI = Math.PI

      ctx.beginPath()
      ctx.moveTo(x, y)

      // 绘制上面的圆形轨迹（从最底下0.5转一圈回到原点2.5）
      ctx.arc(x + l / 2, y - r + 2.5, r, (0.5 + 0.25) * PI, (2.5 - 0.25) * PI)
      ctx.lineTo(x + l, y)

      // 绘制左边的圆形轨迹 （从最左边1转一圈回到原点3）
      ctx.arc(x + l + r - 2.5, y + l / 2, r, (1 + 0.25) * PI, (3 - 0.25) * PI)

      // 绘制矩形轨迹
      ctx.lineTo(x + l, y + l)
      ctx.lineTo(x, y + l)

      // 绘制左边凹进去的半圆（从最左边1逆时针转一圈回到原点3）
      ctx.arc(x + r - 2.5, y + l / 2, r, (3 - 0.25) * PI, (1 + 0.25) * PI, true)
      ctx.lineTo(x, y)
      ctx.lineWidth = 2

      ctx.fillStyle = 'rgba(255, 255, 255, 0.5)' // 填充颜色
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)' // 边框颜色
      ctx.stroke()
      ctx.globalCompositeOperation = 'destination-over'

      ctx[operation === 'fill' ? 'fill' : 'clip']() //填充 or 裁剪
    },

    bindEvents() {
      let oX = 0
      let oY = 0
      let canMove = false

      const dragStart = (e) => {
        oX = e.x
        oY = e.y
        canMove = true
      }

      const dragMove = (e) => {
        if (!canMove) return

        const mX = e.x - oX
        const mY = e.y - oY

        if (mX < 0 || mX + this.l + this.r * 2 >= this.w) return

        this.slider.style.left = this.retPx(mX)
        this.jigsaw.style.left = this.retPx(mX)
      }

      const dragEnd = (e) => {
        console.log(canMove)
        if (!canMove) return

        const left = parseInt(this.jigsaw.style.left)
        if (Math.abs(left - this.x) < 10) {
          this.slider.innerHTML = '√'
        } else {
          this.slider.innerHTML = '×'
          setTimeout(() => {
            this.reset()
            this.slider.innerHTML = '→'
          }, 1000)
        }

        canMove = false
        document.removeEventListener('mousemove', dragMove)
        document.removeEventListener('mouseup', dragEnd)
      }

      this.slider.addEventListener('mousedown', dragStart)
      document.addEventListener('mousemove', dragMove)
      document.addEventListener('mouseup', dragEnd)
    },

    retPx(num) {
      return num + 'px'
    },
  }
  slideJigsaw.init()
</script>
</body>
</html>