<template><h1 id="宝塔重新编译nginx-隐藏server信息和版本信息" tabindex="-1"><a class="header-anchor" href="#宝塔重新编译nginx-隐藏server信息和版本信息" aria-hidden="true">#</a> 宝塔重新编译nginx，隐藏server信息和版本信息</h1>
<p><strong>环境</strong><br>
系统: CentOS Linux 7.6.1810 (Core)<br>
宝塔：免费版 5.9.1<br>
Nginx版本：1.15</p>
<p><strong>需求</strong><br>
隐藏nginx的server信息和版本信息</p>
<h2 id="修改配置和源码" tabindex="-1"><a class="header-anchor" href="#修改配置和源码" aria-hidden="true">#</a> 修改配置和源码</h2>
<p>1.隐藏版本信息</p>
<p>在nginx.conf里面添加</p>
<div class="language-javascript ext-js"><pre v-pre class="language-javascript"><code>server_tokens off<span class="token punctuation">;</span> 
</code></pre></div><p>2.隐藏server信息（需要重新编译ngnix）</p>
<p>进入nginx源码目录/www/server/nginx/src</p>
<div class="language-javascript ext-js"><pre v-pre class="language-javascript"><code># vi src<span class="token operator">/</span>http<span class="token operator">/</span>ngx_http_header_filter_module<span class="token punctuation">.</span>c 
</code></pre></div><p>将</p>
<div class="language-javascript ext-js"><pre v-pre class="language-javascript"><code><span class="token keyword">static</span> u_char ngx_http_server_string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Server: nginx"</span> <span class="token constant">CRLF</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> u_char ngx_http_server_full_string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Server: "</span> <span class="token constant">NGINX_VER</span> <span class="token constant">CRLF</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> u_char ngx_http_server_build_string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Server: "</span> <span class="token constant">NGINX_VER_BUILD</span> <span class="token constant">CRLF</span><span class="token punctuation">;</span> 
</code></pre></div><p>改为</p>
<div class="language-javascript ext-js"><pre v-pre class="language-javascript"><code><span class="token keyword">static</span> u_char ngx_http_server_string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Server: webServer"</span> <span class="token constant">CRLF</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> u_char ngx_http_server_full_string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Server: webServer"</span> <span class="token constant">CRLF</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> u_char ngx_http_server_build_string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Server: webServer"</span> <span class="token constant">CRLF</span><span class="token punctuation">;</span> 
</code></pre></div><h2 id="重新编译nginx" tabindex="-1"><a class="header-anchor" href="#重新编译nginx" aria-hidden="true">#</a> 重新编译nginx</h2>
<p>由于使用宝塔安装nginx，所以可以参考宝塔安装脚本：<code>/www/server/panel/install/nginx.sh</code></p>
<div class="language-javascript ext-js"><pre v-pre class="language-javascript"><code><span class="token operator">...</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"${version}"</span> <span class="token operator">==</span> <span class="token string">"1.15"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>then
        <span class="token punctuation">.</span><span class="token operator">/</span>configure <span class="token operator">--</span>user<span class="token operator">=</span>www <span class="token operator">--</span>group<span class="token operator">=</span>www <span class="token operator">--</span>prefix<span class="token operator">=</span>$<span class="token punctuation">{</span>Setup_Path<span class="token punctuation">}</span> <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>openssl<span class="token operator">=</span>$<span class="token punctuation">{</span>Setup_Path<span class="token punctuation">}</span><span class="token operator">/</span>src<span class="token operator">/</span>openssl <span class="token operator">--</span>add<span class="token operator">-</span>module<span class="token operator">=</span>$<span class="token punctuation">{</span>Setup_Path<span class="token punctuation">}</span><span class="token operator">/</span>src<span class="token operator">/</span>ngx_devel_kit <span class="token operator">--</span>add<span class="token operator">-</span>module<span class="token operator">=</span>$<span class="token punctuation">{</span>Setup_Path<span class="token punctuation">}</span><span class="token operator">/</span>src<span class="token operator">/</span>lua_nginx_module <span class="token operator">--</span>add<span class="token operator">-</span>module<span class="token operator">=</span>$<span class="token punctuation">{</span>Setup_Path<span class="token punctuation">}</span><span class="token operator">/</span>src<span class="token operator">/</span>ngx_cache_purge <span class="token operator">--</span>add<span class="token operator">-</span>module<span class="token operator">=</span>$<span class="token punctuation">{</span>Setup_Path<span class="token punctuation">}</span><span class="token operator">/</span>src<span class="token operator">/</span>nginx<span class="token operator">-</span>sticky<span class="token operator">-</span>module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_stub_status_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_ssl_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_v2_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_image_filter_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_gzip_static_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_gunzip_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>stream <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>stream_ssl_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>ipv6 <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_sub_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_flv_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_addition_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_realip_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_mp4_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>ld<span class="token operator">-</span>opt<span class="token operator">=</span><span class="token string">"-Wl,-E"</span> <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>openssl<span class="token operator">-</span>opt<span class="token operator">=</span><span class="token string">"enable-tls1_3 enable-weak-ssl-ciphers"</span> <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>cc<span class="token operator">-</span>opt<span class="token operator">=</span><span class="token string">"-Wno-error"</span> $<span class="token punctuation">{</span>jemallocLD<span class="token punctuation">}</span>
<span class="token operator">...</span> 
</code></pre></div><blockquote>
<p>将 ${Setup_Path} 改为 /www/server/nginx<br>
将 ${jemallocLD} 改为 --with-ld-opt=&quot;-ljemalloc&quot;</p>
</blockquote>
<p><strong>编译nginx</strong></p>
<div class="language-javascript ext-js"><pre v-pre class="language-javascript"><code># cd <span class="token operator">/</span>www<span class="token operator">/</span>server<span class="token operator">/</span>nginx<span class="token operator">/</span>src
# <span class="token punctuation">.</span><span class="token operator">/</span>configure <span class="token operator">--</span>user<span class="token operator">=</span>www <span class="token operator">--</span>group<span class="token operator">=</span>www <span class="token operator">--</span>prefix<span class="token operator">=</span><span class="token operator">/</span>www<span class="token operator">/</span>server<span class="token operator">/</span>nginx <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>openssl<span class="token operator">=</span><span class="token operator">/</span>www<span class="token operator">/</span>server<span class="token operator">/</span>nginx<span class="token operator">/</span>src<span class="token operator">/</span>openssl <span class="token operator">--</span>add<span class="token operator">-</span>module<span class="token operator">=</span><span class="token operator">/</span>www<span class="token operator">/</span>server<span class="token operator">/</span>nginx<span class="token operator">/</span>src<span class="token operator">/</span>ngx_devel_kit <span class="token operator">--</span>add<span class="token operator">-</span>module<span class="token operator">=</span><span class="token operator">/</span>www<span class="token operator">/</span>server<span class="token operator">/</span>nginx<span class="token operator">/</span>src<span class="token operator">/</span>lua_nginx_module <span class="token operator">--</span>add<span class="token operator">-</span>module<span class="token operator">=</span><span class="token operator">/</span>www<span class="token operator">/</span>server<span class="token operator">/</span>nginx<span class="token operator">/</span>src<span class="token operator">/</span>ngx_cache_purge <span class="token operator">--</span>add<span class="token operator">-</span>module<span class="token operator">=</span><span class="token operator">/</span>www<span class="token operator">/</span>server<span class="token operator">/</span>nginx<span class="token operator">/</span>src<span class="token operator">/</span>nginx<span class="token operator">-</span>sticky<span class="token operator">-</span>module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_stub_status_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_ssl_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_v2_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_image_filter_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_gzip_static_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_gunzip_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>stream <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>stream_ssl_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>ipv6 <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_sub_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_flv_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_addition_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_realip_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>http_mp4_module <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>ld<span class="token operator">-</span>opt<span class="token operator">=</span><span class="token string">"-Wl,-E"</span> <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>openssl<span class="token operator">-</span>opt<span class="token operator">=</span><span class="token string">"enable-tls1_3 enable-weak-ssl-ciphers"</span> <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>cc<span class="token operator">-</span>opt<span class="token operator">=</span><span class="token string">"-Wno-error"</span> <span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>ld<span class="token operator">-</span>opt<span class="token operator">=</span><span class="token string">"-ljemalloc"</span>
# make <span class="token operator">&amp;&amp;</span> make install 
</code></pre></div><p>重启nginx即可</p>
</template>
